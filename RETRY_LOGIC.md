# ğŸ”„ AQI Iran - Retry Logic Ùˆ Fallback Mechanism

## ğŸ“‹ Ø®Ù„Ø§ØµÙ‡

Ø³ÛŒØ³ØªÙ… Ø§Ú©Ù†ÙˆÙ† Ø¨Ø§ **Smart Retry Logic** Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡:
- Ø§Ú¯Ø± Ø³Ø§ÛŒØª **DOWN** Ø¨Ø§Ø´Ø¯ØŒ Ù‡Ø± **10 Ø¯Ù‚ÛŒÙ‚Ù‡** ØªØ³Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯
- Ø³Ù‡ Ø¨Ø§Ø± ØªÙ„Ø§Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ Ø³Ù¾Ø³ Ø¨Ù‡ **Ù†ÛŒÙ…â€ŒØ³Ø§Ø¹ØªÛŒ** Ø¨Ø§Ø²Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯
- Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø§ **[Main]** Ùˆ **[Retry]** tags

---

## ğŸ¯ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø±

### **Ø³Ù†Ø§Ø±ÛŒÙˆ 1: Ø³Ø§ÛŒØª Ø¹Ø§Ø¯ÛŒ Ø§Ø³Øª**

```
12:00 âœ… [Main]   Scrape successful â†’ ØªØ§ 12:30
12:30 âœ… [Main]   Scrape successful â†’ ØªØ§ 13:00
13:00 âœ… [Main]   Scrape successful â†’ ØªØ§ 13:30
```

### **Ø³Ù†Ø§Ø±ÛŒÙˆ 2: Ø³Ø§ÛŒØª ÛŒÚ© Ø¨Ø§Ø± DOWN Ø´Ø¯**

```
12:00 âœ… [Main]    Scrape successful
12:30 âŒ [Main]    Scrape FAILED (site DOWN)
12:40 ğŸ”„ [Retry]   Attempt 2 â†’ FAILED
12:50 ğŸ”„ [Retry]   Attempt 3 â†’ FAILED
13:00 âœ… [Main]    Back to schedule â†’ successful
13:30 âœ… [Main]    Scrape successful
```

### **Ø³Ù†Ø§Ø±ÛŒÙˆ 3: Ø³Ø§ÛŒØª Ù…ØªÙˆØ§Ù„ÛŒ DOWN Ø¨ÙˆØ¯**

```
12:00 âŒ [Main]    FAILED
12:10 ğŸ”„ [Retry]   FAILED
12:20 ğŸ”„ [Retry]   FAILED
12:30 âŒ [Main]    Consecutive failure #1
12:40 ğŸ”„ [Retry]   FAILED
12:50 ğŸ”„ [Retry]   FAILED
13:00 âŒ [Main]    Consecutive failure #2
13:10 ğŸ”„ [Retry]   FAILED
13:20 ğŸ”„ [Retry]   FAILED
13:30 âŒ [Main]    Consecutive failure #3 â†’ âš ï¸ Alert!
14:00 âœ… [Main]    Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø¹Ø§Ø¯ÛŒ
```

---

## ğŸ”§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª

### `config.py`

```python
SCHEDULE_INTERVAL_MINUTES = 30      # Ù†ÛŒÙ…â€ŒØ³Ø§Ø¹ØªÛŒ
MAX_RETRIES = 3                     # 3 ØªÙ„Ø§Ø´
RETRY_DELAY_MINUTES = 10            # 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨ÛŒÙ† ØªÙ„Ø§Ø´â€ŒÙ‡Ø§
```

---

## ğŸ“ Ù†Ù…ÙˆÙ†Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§

### **Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ:**

```
[2025-12-03 12:00:15] INFO: ================================================================================
[2025-12-03 12:00:15] INFO: â° [Main] Starting main scrape at 2025-12-03T12:00:15.123456+0330
[2025-12-03 12:00:15] INFO: ================================================================================
[2025-12-03 12:00:15] INFO: âœ… [Main] Site is UP at 2025-12-03T12:00:15.456789+0330
[2025-12-03 12:00:15] INFO: ğŸ“ [Main] Attempt 1 at 2025-12-03T12:00:15.789012+0330
[2025-12-03 12:00:35] INFO: âœ… [Main] Success: 31 states collected at 2025-12-03T12:00:35.234567+0330
```

### **Ø¨Ø§ Retry:**

```
[2025-12-03 12:30:15] INFO: ================================================================================
[2025-12-03 12:30:15] INFO: â° [Main] Starting main scrape at 2025-12-03T12:30:15.123456+0330
[2025-12-03 12:30:15] INFO: ================================================================================
[2025-12-03 12:30:15] WARNING: ğŸš¨ [Main] Site is DOWN at 2025-12-03T12:30:15.456789+0330
[2025-12-03 12:30:15] INFO: ğŸ“ [Main] Attempt 1 at 2025-12-03T12:30:15.789012+0330
[2025-12-03 12:30:45] WARNING: âš ï¸ [Retry] Attempt 1 failed. Retrying in 10 minutes at 2025-12-03T12:40:15.234567+0330
[2025-12-03 12:40:15] INFO: ğŸ”„ [Retry] Attempt 2 at 2025-12-03T12:40:15.567890+0330
[2025-12-03 12:40:45] WARNING: âš ï¸ [Retry] Attempt 2 failed. Retrying in 10 minutes at 2025-12-03T12:50:15.123456+0330
[2025-12-03 12:50:15] INFO: ğŸ”„ [Retry] Attempt 3 at 2025-12-03T12:50:15.456789+0330
[2025-12-03 12:50:45] ERROR: âŒ [Retry] All 3 attempts failed at 2025-12-03T12:50:45.789012+0330
[2025-12-03 12:50:45] ERROR: ğŸ”´ Consecutive failures: 1/3
[2025-12-03 13:00:15] INFO: ================================================================================
[2025-12-03 13:00:15] INFO: â° [Main] Starting main scrape at 2025-12-03T13:00:15.123456+0330
[2025-12-03 13:00:15] INFO: ================================================================================
[2025-12-03 13:00:15] INFO: âœ… [Main] Site is UP at 2025-12-03T13:00:15.456789+0330
[2025-12-03 13:00:15] INFO: ğŸ“ [Main] Attempt 1 at 2025-12-03T13:00:15.789012+0330
[2025-12-03 13:00:35] INFO: âœ… [Main] Success: 31 states collected at 2025-12-03T13:00:35.234567+0330
```

---

## ğŸŒ API Endpoints

### **Health Check:**

```bash
curl http://localhost:5000/api/health
```

**Response:**
```json
{
  "status": "ok",
  "timestamp": "2025-12-03T12:00:15.123456+0330",
  "timezone": "Asia/Tehran",
  "site_status": "UP",
  "data_available": true
}
```

### **Site Status:**

```bash
curl http://localhost:5000/api/site-status
```

**Response:**
```json
{
  "site": "https://aqms.doe.ir/App/",
  "status": "UP",
  "timestamp": "2025-12-03T12:00:15.123456+0330",
  "timezone": "Asia/Tehran"
}
```

---

## ğŸ¯ Ø¬Ø±ÛŒØ§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ú©Ø§Ù…Ù„

### **1. Scheduler Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯**

```
Scheduler starts every 60 seconds
```

### **2. Ø¨Ø±Ø±Ø³ÛŒ Ø²Ù…Ø§Ù†**

```
Ø¢ÛŒØ§ 30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ø§Ø¬Ø±Ø§ Ú¯Ø°Ø´ØªÙ‡ Ø§Ø³ØªØŸ
  - Ø¨Ù„Ù‡: Ø§Ø¯Ø§Ù…Ù‡
  - Ø®ÛŒØ±: Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯
```

### **3. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø§ÛŒØª**

```
Ø¢ÛŒØ§ Ø³Ø§ÛŒØª UP Ø§Ø³ØªØŸ
  - Ø¨Ù„Ù‡: Ù¾ÛŒØ´ Ø±ÙØªÙ†
  - Ø®ÛŒØ±: Ù‡Ø´Ø¯Ø§Ø± Ùˆ ØªÙ„Ø§Ø´
```

### **4. ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ**

```
Attempt 1:
  - Ù…ÙˆÙÙ‚ØŸ â†’ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯
  - Ù†Ø§Ù…ÙˆÙÙ‚ØŸ â†’ ØµØ¨Ø± 10 Ø¯Ù‚ÛŒÙ‚Ù‡

Attempt 2 (10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø¹Ø¯):
  - Ù…ÙˆÙÙ‚ØŸ â†’ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯
  - Ù†Ø§Ù…ÙˆÙÙ‚ØŸ â†’ ØµØ¨Ø± 10 Ø¯Ù‚ÛŒÙ‚Ù‡

Attempt 3 (10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø¹Ø¯):
  - Ù…ÙˆÙÙ‚ØŸ â†’ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯
  - Ù†Ø§Ù…ÙˆÙÙ‚ØŸ â†’ Ø´Ù…Ø§Ø±Ø´ Ù†Ø§Ú©Ø§Ù…ÛŒ Ù…ØªÙˆØ§Ù„ÛŒ
```

### **5. Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Schedule**

```
Ú†Ù‡ Ø§ØªÙØ§Ù‚ÛŒ Ø§ÙØªØ§Ø¯:
  - Ù…ÙˆÙÙ‚: Consecutive failures = 0 âœ…
  - Ù†Ø§Ù…ÙˆÙÙ‚: Consecutive failures += 1 âŒ
  
Ø§Ú¯Ø± 3 Ø¨Ø§Ø± Ù…ØªÙˆØ§Ù„ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚:
  â†’ âš ï¸ Alert!
  â†’ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯ ØªØ§ Ø²Ù…Ø§Ù† Ø§ØµÙ„ÛŒ
  â†’ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø² Ø´Ø±ÙˆØ¹
```

---

## ğŸ” Ù†Ø­ÙˆÙ‡ ØªØ³Øª

### **Test 1: Ø§Ø¬Ø±Ø§ÛŒ Ø³Ø§Ø¯Ù‡**

```bash
python3 scheduler.py
```

### **Test 2: Ø¨Ø±Ø±Ø³ÛŒ API**

```bash
# Health
curl http://localhost:5000/api/health

# Site Status
curl http://localhost:5000/api/site-status

# All AQI Data
curl http://localhost:5000/api/aqi
```

### **Test 3: Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§**

```bash
# Cron
tail -f logs/cron.log

# Systemd
journalctl --user -u aqi-scheduler -f
```

---

## âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡

### **ØªØºÛŒÛŒØ± ÙØ§ØµÙ„Ù‡ Retry:**

`config.py`:
```python
RETRY_DELAY_MINUTES = 15  # Ø¨Ø¬Ø§ÛŒ 10
```

### **ØªØºÛŒÛŒØ± ØªØ¹Ø¯Ø§Ø¯ Retries:**

`config.py`:
```python
MAX_RETRIES = 5  # Ø¨Ø¬Ø§ÛŒ 3
```

### **ØªØºÛŒÛŒØ± Schedule Interval:**

`config.py`:
```python
SCHEDULE_INTERVAL_MINUTES = 60  # Ø¨Ø¬Ø§ÛŒ 30
```

---

## ğŸ“Š Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ú©Ø§Ø±Ú©Ø±Ø¯

- âœ… **Health Check**: Ù‡Ø± 60 Ø«Ø§Ù†ÛŒÙ‡
- âœ… **Site Status Check**: Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø± ØªÙ„Ø§Ø´
- âœ… **Retry Interval**: 10 Ø¯Ù‚ÛŒÙ‚Ù‡
- âœ… **Schedule Interval**: 30 Ø¯Ù‚ÛŒÙ‚Ù‡
- âœ… **Max Consecutive Failures**: 3

---

## ğŸš€ Ù†ØªÛŒØ¬Ù‡â€ŒÚ¯ÛŒØ±ÛŒ

Ø³ÛŒØ³ØªÙ… Ø§Ú©Ù†ÙˆÙ† **Production-Ready** Ø§Ø³Øª Ùˆ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯:
- âœ… Ø¨Ø§ Ø®Ø±Ø§Ø¨ÛŒ Ø³Ø§ÛŒØª Ù…Ù‚Ø§Ø¨Ù„Ù‡ Ú©Ù†Ø¯
- âœ… Ø®ÙˆØ¯Ú©Ø§Ø± retry Ú©Ù†Ø¯
- âœ… Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø«Ø¨Øª Ú©Ù†Ø¯
- âœ… Ø¨Ù‡ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø¯
- âœ… Ù‡Ø´Ø¯Ø§Ø± Ø¯Ù‡Ø¯ Ø§Ú¯Ø± Ù…Ø´Ú©Ù„ÛŒ Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯

